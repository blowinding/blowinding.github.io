# DRILL

## motivation

该论文主要研究`微负载均衡`，即研究交换机中对每个包的转发行为。每个转发引擎会比较两个随机端口加上前一次选择中负载最小的端口的队列长度，并将数据包发送给这三者中当前负载最小的那个端口。

## design

首先提出ESF(Equal Split Fluid)，对于每个具有 n 条最小代价路径到达某个目的地的交换机，ESF 要求该交换机将流体流量平均分配到这 n 条路径上，即每条路径发送 1/n 的流量。

负载均衡算法需要尝试逼近ESF，但是现今的ECMP有两个问题：

- 它以非常粗粒度的“完整流（flow）”为单位进行决策。

- 它使用与负载无关的伪随机方式进行均匀分配，容易导致偶然的负载碰撞。

本论文提出DRILL。首先，DRILL 选择了最小的可行离散单元：单个数据包。这种粒度是交换机能够以无状态方式简单处理的决策单位（同时也避免了终端主机在进行逐包转发决策时可能面临的开销问题，因为转发决策由交换机完成）。其次，DRILL 并不采用均匀随机地进行流量转发。相反，DRILL 利用了交换机本地的负载信息，在每次做包转发决策时，会采样部分或全部出口队列，并将该包放入其中当前排队最短的队列。

DRILL面临两个挑战：Packet reordering和Topological asymmetry，并且在拓扑极其不对称的情况下，DRILL会降级为ECMP。

算法说明：DRILL(d, m)
在每个交换机中，DRILL(d, m) 算法的具体步骤如下：

- 每当一个数据包到达时，该包所在的转发引擎会从所有 N 个可用出口端口中随机选择 d 个端口。

- 然后，它在这 d 个采样端口中，以及历史记录中记忆的 m 个负载最轻端口中，找出当前队列占用最小的那个端口，将该数据包转发到该端口。

- 最后，转发引擎会更新其记忆中的 m 个单元，将最新采样中队列最轻的端口记录进去。

对不同规模 Clos 网络、不同数量转发引擎的交换机以及不同负载水平进行的实验中，得出以下结论：

(a) 仅使用少量的选择数和记忆单元对算法效率至关重要，例如 DRILL(2,1) 就显著优于 Per-packet Random（逐包随机）和 RR（轮询）。

(b) 将 d 提高到 2 以上、m 提高到 1 以上对 DRILL 的性能提升有限，有时甚至会因**同步效应（synchronization effect）**而导致性能下降。

在一个交换机拥有 48 个引擎、负载为 80% 的网络中，

在 DRILL(1,1) 基础上仅增加一个记忆单元（即 DRILL(1,2)）时，平均队列长度的标准差（STDV）减少了 11%；

但当使用 20 个记忆单元（即 DRILL(1,20)）时，该指标反而上升了 8%。

原因在于：随机采样数或记忆单元过多会使得大量转发引擎更容易同时选择相同的一组出口端口，从而在这些端口产生突发的拥塞。我们称这一现象为同步效应（synchronization effect）

