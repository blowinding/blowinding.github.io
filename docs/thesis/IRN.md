# IRN(improved RoCE NIC)

IRN相对于普通的RoCE增加了丢包检测机制以及基础的端到端流量控制（BDP-FC）。

### IRN’s Loss Recovery Mechanism

每当接收到一个乱序的数据包时，IRN 接收端会发送一个 NACK（否定确认）。
这个 NACK 包含两个信息：

累计确认号（表示它期望接收的下一个序列号）；

触发该 NACK 的数据包的序列号（作为一种简化形式的选择性确认，即 SACK）。

SACK 机制只有在存在多个在途数据包（in-flight packets）时才有助于高效的丢包恢复。
而在其他情况下（例如只包含一个数据包的消息），丢包恢复是通过超时触发的。
过高的超时设置会增加这类短消息的尾部延迟（tail latency）；
但超时时间设得太低又可能导致过多的误重传（spurious retransmission），从而影响整体性能。

因此，IRN 发送端采用如下策略：

当在途数据包数量较少（仅有少量 N 个）时，使用一个较小的超时时间 RTO<sub>low</sub>，
此时误重传的风险非常小；

否则，则使用一个较大的超时时间 RTO<sub>high</sub>。

### IRN’s BDP-FC Mechanism

我们通过将网络中**最长路径的带宽-时延积（BDP，以字节为单位）**除以 RDMA 队列对设置的 数据包最大传输单元（MTU）来计算（通常在 RoCE 网卡中 MTU 为 1KB）。

IRN 发送端只有在“在途数据包”数量小于该 BDP 限制值时，才会发送新的数据包。
“在途数据包”数量通过当前数据包的序列号减去最后一个已确认的数据包序列号来计算。

BDP-FC（基于带宽-时延积的流控）通过减少网络中不必要的排队，提高了性能。
此外，通过严格限制乱序包的到达数量，它极大地减少了网卡中用于追踪丢包的状态开销。

正如前文提到的，IRN 的丢包恢复机制借鉴了 TCP 的丢包恢复思想。
但与 iWARP 网卡将整个 TCP 协议栈集成到网卡中不同，IRN 做出了以下简化设计：

将丢包恢复与拥塞控制解耦，不采用 TCP 的拥塞窗口控制机制（如慢启动、AIMD 或快速恢复）；

直接以 RDMA 数据段为操作对象，而不是采用 TCP 的字节流抽象。
这样不仅避免了 iWARP 中多层协议转换带来的复杂性，
还使得 IRN 能够简化其选择性确认机制和丢包跟踪机制。