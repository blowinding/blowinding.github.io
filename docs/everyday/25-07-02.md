# 25-07-02

## 今日工作

主要阅读了bf-p4c的源码，大致了解了bf-p4c源码的主要架构，其主要分为midend以及backend。

midend部分主要包括以下几点：

- 顺序动作分析：ToFino 的动作是并行执行的，因此，为了确保正确的顺序行为，我们需要分析这些动作，并用中间临时变量（本质上是复制传播）来替代，以确保每个动作中的基本操作能够并行执行。

- 字段打包和解包：ToFino 只能处理 8 位、16 位和 32 位的量，因此，大于 32 位的字段必须被拆分。解析器按字节操作，因此，需要解析/去解析的头部字段，如果不是字节对齐的，需要重新组织这些字段以便它们能够按字节对齐。这可能需要引入额外的元数据。

- POV 分配：ToFino 需要将 POV 位作为附加元数据存储，以供去解析器控制去解析。这些位还应该用于表中头部有效性的检查。

- 桥接元数据：我们需要引入一个桥接元数据假头部，它会在入口解析器和出口解析器之间去解析，传递元数据信息。

backend部分主要包括p4 IR按照tofino特定硬件的封装以及parde、mau、phv的passes。

tofino特定IR封装主要包括`IR::BFN::Pipe`，基类`IR::BFN::Unit`，`IR::BFN::Parser`，`IR::MAU::Table`，`IR::MAU::TableSeq`，以上类分别在`ir/tofino.def`，`ir/parde.def`，`ir/mau.def`文件中可以找到。

## 日后工作想法

bf-p4c源码过于复杂，不适合直接阅读并且太耗费时间，鉴于阅读此代码的初心是了解p4代码如何转换为tofino交换机可以理解的形式以及寻找隐式规则，日后阅读此代码需要有更强的目的性。同时，需要尝试在tofino交换机中运行已经编译好的p4代码以尝试进行功能测试，功能测试需要根据数据平面代码调整控制平面代码（PTF）。

## 随记

今天下午和朋友吃完路边的炒面之后，觉得今天基本上什么都没干比较郁闷，又去doc广场买了西瓜和小面包留着晚上和明天早上吃。看见doc广场负一层的超市有卖生鲜的，于是再次产生了在宿舍里做饭的想法。不过鉴于在宿舍炒菜油烟不好处理，只能试着做一些炖菜，还可以减少每天油的摄入量。

在去doc的路上，看见好多人在拍天空，于是想到了尘封好几天的dji mini 4k，希望周末的时候可以在港里面放飞一下“理想”。

今天除了漫无目的的看了些代码其他什么都没干，想加快进度又不知道从何下手，处于一种比较迷惘的状态，也许科研就是这样，早知道不如直接去工作（？）

今天第一次在记录工作的同时，记录一下自己的生活，希望未来能够保持。