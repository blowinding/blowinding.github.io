
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://blowindingblog.cn/learning/The%20All%20New%20Switch%20Book/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>The All New Switch Book - blowinding's blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      
  
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
  
  <style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M1%207.775V2.75C1%201.784%201.784%201%202.75%201h5.025c.464%200%20.91.184%201.238.513l6.25%206.25a1.75%201.75%200%200%201%200%202.474l-5.026%205.026a1.75%201.75%200%200%201-2.474%200l-6.25-6.25A1.75%201.75%200%200%201%201%207.775m1.5%200c0%20.066.026.13.073.177l6.25%206.25a.25.25%200%200%200%20.354%200l5.025-5.025a.25.25%200%200%200%200-.354l-6.25-6.25a.25.25%200%200%200-.177-.073H2.75a.25.25%200%200%200-.25.25ZM6%205a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2.5%201.75v11.5c0%20.138.112.25.25.25h3.17a.75.75%200%200%201%200%201.5H2.75A1.75%201.75%200%200%201%201%2013.25V1.75C1%20.784%201.784%200%202.75%200h8.5C12.216%200%2013%20.784%2013%201.75v7.736a.75.75%200%200%201-1.5%200V1.75a.25.25%200%200%200-.25-.25h-8.5a.25.25%200%200%200-.25.25m13.274%209.537zl-4.557%204.45a.75.75%200%200%201-1.055-.008l-1.943-1.95a.75.75%200%200%201%201.062-1.058l1.419%201.425%204.026-3.932a.75.75%200%201%201%201.048%201.074M4.75%204h4.5a.75.75%200%200%201%200%201.5h-4.5a.75.75%200%200%201%200-1.5M4%207.75A.75.75%200%200%201%204.75%207h2a.75.75%200%200%201%200%201.5h-2A.75.75%200%200%201%204%207.75%22/%3E%3C/svg%3E');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M0%208a8%208%200%201%201%2016%200A8%208%200%200%201%200%208m8-6.5a6.5%206.5%200%201%200%200%2013%206.5%206.5%200%200%200%200-13M6.5%207.75A.75.75%200%200%201%207.25%207h1a.75.75%200%200%201%20.75.75v2.75h.25a.75.75%200%200%201%200%201.5h-2a.75.75%200%200%201%200-1.5h.25v-2h-.25a.75.75%200%200%201-.75-.75M8%206a1%201%200%201%201%200-2%201%201%200%200%201%200%202%22/%3E%3C/svg%3E');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M3.499.75a.75.75%200%200%201%201.5%200v.996C5.9%202.903%206.793%203.65%207.662%204.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873%2010.794-.045%2012.622.26%2014.408.558%2016%201.94%2016%204.25c0%201.278-.954%202.575-2.44%202.734l.146.508.065.22c.203.701.412%201.455.476%202.226.142%201.707-.4%203.03-1.487%203.898C11.714%2014.671%2010.27%2015%208.75%2015h-6a.75.75%200%200%201%200-1.5h1.376a4.5%204.5%200%200%201-.563-1.191%203.84%203.84%200%200%201-.05-2.063%204.65%204.65%200%200%201-2.025-.293.75.75%200%200%201%20.525-1.406c1.357.507%202.376-.006%202.698-.318l.009-.01a.747.747%200%200%201%201.06%200%20.75.75%200%200%201-.012%201.074c-.912.92-.992%201.835-.768%202.586.221.74.745%201.337%201.196%201.621H8.75c1.343%200%202.398-.296%203.074-.836.635-.507%201.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.4%202.4%200%200%201-.507-.441%203.1%203.1%200%200%201-.633-1.248.75.75%200%200%201%201.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738%200%201.25-.615%201.25-1.25%200-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706%201.345-.46.92-.27%201.774.019%203.062l.042.19.01.05c.348.443.666.949.94%201.553a.75.75%200%201%201-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7%205.527c-.814-.68-1.75-1.462-2.692-2.619a3.7%203.7%200%200%200-1.023.88c-.406.495-.663%201.036-.722%201.508.116.122.306.21.591.239.388.038.797-.06%201.032-.19a.75.75%200%200%201%20.728%201.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75%205.677V5.5c0-.984.48-1.94%201.077-2.664.46-.559%201.05-1.055%201.673-1.353z%22/%3E%3C/svg%3E');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M13.78%204.22a.75.75%200%200%201%200%201.06l-7.25%207.25a.75.75%200%200%201-1.06%200L2.22%209.28a.75.75%200%200%201%20.018-1.042.75.75%200%200%201%201.042-.018L6%2010.94l6.72-6.72a.75.75%200%200%201%201.06%200%22/%3E%3C/svg%3E');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M0%208a8%208%200%201%201%2016%200A8%208%200%200%201%200%208m8-6.5a6.5%206.5%200%201%200%200%2013%206.5%206.5%200%200%200%200-13M6.92%206.085h.001a.749.749%200%201%201-1.342-.67c.169-.339.436-.701.849-.977C6.845%204.16%207.369%204%208%204a2.76%202.76%200%200%201%201.637.525c.503.377.863.965.863%201.725%200%20.448-.115.83-.329%201.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6%206%200%200%200-.26.16%201%201%200%200%200-.276.245.75.75%200%200%201-1.248-.832c.184-.264.42-.489.692-.661q.154-.1.313-.195l.007-.004c.1-.061.182-.11.258-.161a1%201%200%200%200%20.277-.245C8.96%206.514%209%206.427%209%206.25a.61.61%200%200%200-.262-.525A1.27%201.27%200%200%200%208%205.5c-.369%200-.595.09-.74.187a1%201%200%200%200-.34.398M9%2011a1%201%200%201%201-2%200%201%201%200%200%201%202%200%22/%3E%3C/svg%3E');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M6.457%201.047c.659-1.234%202.427-1.234%203.086%200l6.082%2011.378A1.75%201.75%200%200%201%2014.082%2015H1.918a1.75%201.75%200%200%201-1.543-2.575Zm1.763.707a.25.25%200%200%200-.44%200L1.698%2013.132a.25.25%200%200%200%20.22.368h12.164a.25.25%200%200%200%20.22-.368Zm.53%203.996v2.5a.75.75%200%200%201-1.5%200v-2.5a.75.75%200%200%201%201.5%200M9%2011a1%201%200%201%201-2%200%201%201%200%200%201%202%200%22/%3E%3C/svg%3E');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2.344%202.343za8%208%200%200%201%2011.314%2011.314A8.002%208.002%200%200%201%20.234%2010.089a8%208%200%200%201%202.11-7.746m1.06%2010.253a6.5%206.5%200%201%200%209.108-9.275%206.5%206.5%200%200%200-9.108%209.275M6.03%204.97%208%206.94l1.97-1.97a.749.749%200%200%201%201.275.326.75.75%200%200%201-.215.734L9.06%208l1.97%201.97a.749.749%200%200%201-.326%201.275.75.75%200%200%201-.734-.215L8%209.06l-1.97%201.97a.749.749%200%200%201-1.275-.326.75.75%200%200%201%20.215-.734L6.94%208%204.97%206.03a.75.75%200%200%201%20.018-1.042.75.75%200%200%201%201.042-.018%22/%3E%3C/svg%3E');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M9.504.43a1.516%201.516%200%200%201%202.437%201.713L10.415%205.5h2.123c1.57%200%202.346%201.909%201.22%203.004l-7.34%207.142a1.25%201.25%200%200%201-.871.354h-.302a1.25%201.25%200%200%201-1.157-1.723L5.633%2010.5H3.462c-1.57%200-2.346-1.909-1.22-3.004zm1.047%201.074L3.286%208.571A.25.25%200%200%200%203.462%209H6.75a.75.75%200%200%201%20.694%201.034l-1.713%204.188%206.982-6.793A.25.25%200%200%200%2012.538%207H9.25a.75.75%200%200%201-.683-1.06l2.008-4.418.003-.006-.004-.009-.006-.006-.008-.001q-.005%200-.009.004%22/%3E%3C/svg%3E');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M4.72.22a.75.75%200%200%201%201.06%200l1%20.999a3.5%203.5%200%200%201%202.441%200l.999-1a.748.748%200%200%201%201.265.332.75.75%200%200%201-.205.729l-.775.776c.616.63.995%201.493.995%202.444v.327q0%20.15-.025.292c.408.14.764.392%201.029.722l1.968-.787a.75.75%200%200%201%20.556%201.392L13%207.258V9h2.25a.75.75%200%200%201%200%201.5H13v.5q-.002.615-.141%201.186l2.17.868a.75.75%200%200%201-.557%201.392l-2.184-.873A5%205%200%200%201%208%2016a5%205%200%200%201-4.288-2.427l-2.183.873a.75.75%200%200%201-.558-1.392l2.17-.868A5%205%200%200%201%203%2011v-.5H.75a.75.75%200%200%201%200-1.5H3V7.258L.971%206.446a.75.75%200%200%201%20.558-1.392l1.967.787c.265-.33.62-.583%201.03-.722a1.7%201.7%200%200%201-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72%201.28a.75.75%200%200%201%200-1.06m.53%206.28a.75.75%200%200%200-.75.75V11a3.5%203.5%200%201%200%207%200V7.25a.75.75%200%200%200-.75-.75ZM6.173%205h3.654A.17.17%200%200%200%2010%204.827V4.5a2%202%200%201%200-4%200v.327c0%20.096.077.173.173.173%22/%3E%3C/svg%3E');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5%205.782V2.5h-.25a.75.75%200%200%201%200-1.5h6.5a.75.75%200%200%201%200%201.5H11v3.282l3.666%205.76C15.619%2013.04%2014.543%2015%2012.767%2015H3.233c-1.776%200-2.852-1.96-1.899-3.458Zm-2.4%206.565a.75.75%200%200%200%20.633%201.153h9.534a.75.75%200%200%200%20.633-1.153L12.225%2010.5h-8.45ZM9.5%202.5h-3V6c0%20.143-.04.283-.117.403L4.73%209h6.54L9.617%206.403A.75.75%200%200%201%209.5%206Z%22/%3E%3C/svg%3E');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M1.75%202.5h10.5a.75.75%200%200%201%200%201.5H1.75a.75.75%200%200%201%200-1.5m4%205h8.5a.75.75%200%200%201%200%201.5h-8.5a.75.75%200%200%201%200-1.5m0%205h8.5a.75.75%200%200%201%200%201.5h-8.5a.75.75%200%200%201%200-1.5M2.5%207.75v6a.75.75%200%200%201-1.5%200v-6a.75.75%200%200%201%201.5%200%22/%3E%3C/svg%3E');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapter-17-make-the-switch" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="blowinding&#39;s blog" class="md-header__button md-logo" aria-label="blowinding's blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            blowinding's blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              The All New Switch Book
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Introduction

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="blowinding&#39;s blog" class="md-nav__button md-logo" aria-label="blowinding's blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    blowinding's blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chapter-17-make-the-switch" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chapter 17: Make the Switch!
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter 17: Make the Switch!">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keeping-house" class="md-nav__link">
    <span class="md-ellipsis">
      
        Keeping House
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Keeping House">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#housekeeping-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Housekeeping Functions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#switch-data-receive-path-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Switch Data Receive Path Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Switch Data Receive Path Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#port-interfacesreceive" class="md-nav__link">
    <span class="md-ellipsis">
      
        Port Interfaces（Receive）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receive-flow-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        Receive Flow Control
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#link-aggregation-collector" class="md-nav__link">
    <span class="md-ellipsis">
      
        Link Aggregation Collector
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#classification-engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Classification Engine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vlan-filters" class="md-nav__link">
    <span class="md-ellipsis">
      
        VLAN Filters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lookup-engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Lookup Engine
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#switch-fabrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Switch Fabrics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Switch Fabrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shared-memory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shared Memory
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Shared Memory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shared-memory-fabric-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shared Memory Fabric Operation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multicasting-in-a-shared-memory-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multicasting in a Shared Memory Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-organization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Buffer Organization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Buffer Organization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#contiguous-buffers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Contiguous Buffers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#discontiguous-buffers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Discontiguous Buffers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-bandwidth-limitations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Bandwidth Limitations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#increasing-the-memory-bandwidth" class="md-nav__link">
    <span class="md-ellipsis">
      
        Increasing the Memory Bandwidth
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crosspoint-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      
        Crosspoint Matrix
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Crosspoint Matrix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multicasting-in-a-crosspoint-matrix-fabric" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multicasting in a Crosspoint Matrix Fabric
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crosspoint-matrix-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Crosspoint Matrix Implementation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>The All New Switch Book</h1>

<h2 id="chapter-17-make-the-switch">Chapter 17: Make the Switch!</h2>
<h3 id="keeping-house">Keeping House</h3>
<p>目前switch的data path由硬件构建，但是仍需要嵌入式的微处理器支持数据路径以外的一切功能。
Housekeeping processor subsystem的组成如下：
- CPU
- Code/configuration Store（ROM）
    - 存储配置代码
- RAM
    - frame缓存
- local serial port
    - 初始化设备管理、系统debug、代码修改下载等
- 在交换机的端口与housekeeping subsystem之间也必须存在某种方式，用于在接收和发送方向上移动数据</p>
<h4 id="housekeeping-functions">Housekeeping Functions</h4>
<ul>
<li>生成树协议</li>
<li>链路聚合控制协议</li>
<li>Marker协议</li>
<li>已启用的GARP应用</li>
<li>网络管理</li>
<li>内部诊断与维护</li>
</ul>
<h2 id="switch-data-receive-path-functions">Switch Data Receive Path Functions</h2>
<p>![[25-12-10-1.png]]</p>
<h3 id="port-interfacesreceive">Port Interfaces（Receive）</h3>
<p>Media Access Control（MAC）和Physical Layer receiver（PHY）构成了传统的网络接口功能。
- PHY receiver
    - 从传输介质获取电信号或光信号，根据所使用的具体技术将其解码成比特、半字节或字节流。
    - 不同的介质（例如双绞线或光纤）和不同的技术（例如不同的数据速率和 LAN 类型）通常需要不同的 PHY 实现。
- MAC
    - 完成必要的成帧和有效性检查，以便从PHY提供的数据流中重构出格式正确的帧。
    - 接收端 MAC 会在从 PHY 接收数据的同时实时计算帧校验序列（FCS），如果检测到无效的 FCS，MAC 就会丢弃该帧。除了可能为了管理目的而递增一个错误计数器之外，交换机没有必要继续处理任何接收错误的帧。
    - 接收 MAC 通常会维护大多数实时的基于端口的统计计数器。
    - 接收 MAC 必须将接收到的帧存储在本地缓冲区中。若为共享缓存架构，则可能可以仅将帧存储一次到一个公共缓冲池中，从而避免在输入和输出端口之间执行任何缓冲区复制操作。在这种架构下，交换机只需要维护<strong>未处理缓冲区指针列表</strong>，并通过调整各端口的队列数据结构即可，而不必真正将帧数据从端口复制到另一个端口。
从历史上看，PHY 和 MAC 设备是作为单独的封装组件构建的，每个集成电路（IC）只实现一个单元。现代硅工艺能力允许水平和/或垂直集成，也就是说：
- PHY 设备可以以四端口、六端口、八端口甚至更高密度的形式提供，适用于以太网或其他技术。
- MAC 设备同样可提供多实例的封装形式。
- MAC 和 PHY 也可以作为半导体内核，集成到同时执行交换功能的设备中，而不仅仅提供 MAC/PHY 接口。</p>
<h3 id="receive-flow-control">Receive Flow Control</h3>
<p>在接口的接收侧，流控模块会检查进入的流量，以查找 PAUSE 帧（如第 8 章所述）。当接收到一个格式正确的 PAUSE 命令时，<strong>该模块会根据帧中的 pause time 值更新暂停计时器，并向发送侧的流控模块提供相应的控制信号</strong>。例如：
- 如果接收到一个 pause time 非零的 PAUSE 帧，则必须<strong>通知接口的发送侧停止从 MAC 客户端（例如链路聚合分发器）接收待发送的帧</strong>，直到暂停计时器到期。
- 如果接收到一个 pause time 为零的 PAUSE 帧，则发送侧可以重新启用，继续接收待发送的帧。
对 PAUSE 帧进行解析、解释并根据其执行操作，这些功能通常都在专用硬件中实现，原因如下：
- 相关操作简单、明确且范围有限。
- 在接收到 PAUSE 帧与停止发送帧之间的时间受到非常严格的限制：
    - 对于 10 Mb/s 或 100 Mb/s 的接口，最多 512 bit times；
    - 对于 1000 Mb/s 的接口，最多 1024 bit times。
当然，由于链路流量控制仅定义于以太网，对于 Token Ring 或 FDDI 接口则不存在接收流控模块。在这些情况下，所有的帧都会直接从接收 MAC 传递给链路聚合收集器或分类引擎。</p>
<h3 id="link-aggregation-collector">Link Aggregation Collector</h3>
<p>如果多个物理接口聚合成一个逻辑接口，本模块负责实现帧收集功能（Collector）。Collector 从每个底层物理接口收集接收到的帧，并向分类引擎（Classification Engine）呈现一条合并后的单一帧流。Collector 不需要采取任何额外措施来确保从不同物理接口接收的帧之间的顺序正确性。链路的发送侧由 Distributor 负责确保：每个需要保持帧顺序的“会话”（conversation）都会被映射到聚合组中的某一个特定物理链路上。
Collector 还包含 Marker 协议中“响应者（Responder）”部分的实现；此功能可以通过有限状态机实现，也可以在常规微处理器上以软件方式实现。根据具体交换机的设计，通用 housekeeping 处理器也可能被用于生成 Marker Response，只是必须确保响应足够快速。通常，聚合链路另一端的 Distributor 会等待 Marker Response，然后才会把一个或多个会话从某条物理链路切换到另一条物理链路（见 17.4.3）。如果 Marker Response 延迟，会导致这些会话的通信被阻塞。
通常，链路聚合控制协议（LACP）会由 housekeeping 处理器实现，因为它对时间敏感性远低于 Marker 协议。LACP 帧始终使用处于“链路约束协议（link-constrained protocols）”保留地址范围内的多播目的地址；分类引擎会识别这些帧并标记为应本地接收（sink）到 housekeeping 处理器，如本文稍后将讨论的那样。</p>
<h3 id="classification-engine">Classification Engine</h3>
<h3 id="vlan-filters">VLAN Filters</h3>
<h3 id="lookup-engine">Lookup Engine</h3>
<h2 id="switch-fabrics">Switch Fabrics</h2>
<p>switch fabrics是发送端和接受端中间的部分，是交换机的核心。目前局域网中最常见的三种switch fabric架构为：shared memory、shared bus、crosspoint matrix</p>
<h3 id="shared-memory">Shared Memory</h3>
<p>共享内存式架构<strong>在设计和实现两方面都具有最低的复杂度</strong>，并且在适用的产品中通常也是成本最低的解决方案。因此，它是局域网交换机中最常用的交换结构设计方式。
共享内存交换结构的主要限制在于其<strong>内存带宽</strong>：数据写入和读出共享内存的速度，会对交换机可支持的端口数量以及这些端口的数据速率形成上限。
![[25-12-10-2.png]]</p>
<h4 id="shared-memory-fabric-operation">Shared Memory Fabric Operation</h4>
<p>共享内存交换结构（shared memory fabric）使用<strong>单一的公共内存</strong>作为端口之间帧交换的机制，如图 17-9 所示。通过输入端口接收数据路径到达的帧会被存放在共享内存中，然后根据需要被分配并导向相应输出端口的发送数据路径。
理想情况下，帧可以直接从接收端口接口写入共享内存。但在实际中，接收数据路径通常需要在每个端口上配备一定数量的本地内存，用于在接收和分类过程中临时存储帧。不过，系统中绝大部分的内存仍然是位于公共缓冲池中的共享内存。
最初，共享内存中的所有帧缓冲区都是空闲的，它们起始状态位于“空闲缓冲池”中。随着帧从各输入端口到达，这些空闲缓冲区会被分配给新帧。根据查找引擎（Lookup Engine）的结果，存放在共享内存中的帧会被链接到相应输出端口的输出队列中，这些输出队列代表了要在发送数据路径中处理的帧流（见 17.4 节）。丢弃帧的操作通过将其缓冲区归还到空闲池来完成。
使用共享内存结构的优点包括：
- <strong>使用单一的大内存而不是每个端口独立的缓冲内存，可以降低整体内存成本（以及内存控制逻辑的成本）。</strong>
- <strong>从一个端口转发帧到另一个端口变得很简单</strong>.如图 17-9 所示，每个端口的输出（发送）队列只是一个指向存放在共享内存中帧的缓冲指针的链表。将一个帧从输入端口转发到输出端口，只需将该帧缓冲区的指针链接到目标输出端口的队列即可。
- <strong>查找引擎（Lookup Engine）可以使用共享的单一查找单元，也可以分布式部署（每个端口独立查找），取决于查找性能的需求（见 17.2.6 节）</strong>.一些其他交换结构（例如交叉矩阵，见 17.3.3 节）很难使用单一的公共查找引擎。
- <strong>查找操作可以在帧存入共享内存之前完成，也可以在帧存储后与存储操作并行进行</strong>.也就是说，一个帧可以在交换机尚未确定如何处理它时就“先存进去”；一旦查找引擎完成工作，其缓冲指针就可以被链接到正确的输出队列中。</p>
<h4 id="multicasting-in-a-shared-memory-architecture">Multicasting in a Shared Memory Architecture</h4>
<p>![[25-12-11-1.png]]
共享内存结构（shared memory fabric）使得能够将帧从一个输入端口转发到多个输出端口变得更加容易。由于所有端口都可以访问这块公共内存，因此不需要进行多次数据拷贝，也不需要为多播流量提供特殊的数据路径。每个帧缓冲区都可以配备一个“发送端口映射（Transmit Port Map）”，如图 17-10 所示。
查找引擎（Lookup Engine）决定该帧应被转发到哪些输出端口。<strong>如果一帧需要发送到多个输出端口（例如，它是多播帧，或是未知单播帧），则会将发送端口映射中相应的目标端口位置比特设置为 1。</strong>
当某个输出端口的发送数据路径不再需要这帧在共享内存中的副本时（例如，该端口已经完成了帧的发送，或者已经将帧复制到本地端口缓冲区），<strong>它会清除发送端口映射中对应自己端口的比特，并检查是否仍有比特为 1。</strong>
一旦发送端口映射中的所有比特都被清除，表示所有端口都已处理完该帧，该帧缓冲区就可以被归还到空闲池（free pool）。</p>
<h4 id="buffer-organization">Buffer Organization</h4>
<h5 id="contiguous-buffers">Contiguous Buffers</h5>
<p>当缓冲区是连续（contiguous）时，内存接口和控制逻辑的设计要简单得多。一个连续的缓冲区可以通过单一的指针标识，这个指针代表帧起始位置。用于在共享内存中搬移帧数据的 DMA（Direct Memory Access）引擎也可以仅依赖这个单一的缓冲区指针工作，无需将帧分片分散到共享内存中不同的区域，也不需要从不同区域收集数据。
<strong>当帧缓冲区既是连续的又是固定长度时，复杂度最低</strong>.在这种方案中，整个共享内存可以预先划分成独立、编号明确的帧缓冲区。这样就完全不需要复杂的动态内存分配逻辑。然而，每个固定长度的缓冲区都必须足够大，以容纳最大长度的帧；当接收的帧小于最大长度时，内存利用率会降低。因此，内存成本与内存接口逻辑的成本之间存在明显的权衡。
以太网交换机常用的一种方法，是分配固定长度、连续的 2,048（2K）字节缓冲区。一个 2KB 的缓冲区不仅能充分存下最大长度的以太网帧（1,522 字节，包括 VLAN 标签），还可以容纳内部交换头、发送端口映射（Transmit Port Map）以及任何与实现相关的内存控制信息。实际上，其中 526 字节留给内部开销的空间远远超过一般需求。然而，如果采用一个二进制的“整齐数值”作为缓冲区长度，内存接口逻辑可以将缓冲区编号作为每个内存指针的高位，如图 17-11 所示。这进一步简化了硬件逻辑，但代价是内存利用率的降低。
![[25-12-11-2.png]]
虽然可以设计使用可变长度连续缓冲区的共享内存交换结构，但这通常会显著增加内存接口的复杂度，并带来严重的内存碎片化。</p>
<h5 id="discontiguous-buffers">Discontiguous Buffers</h5>
<p>![[25-12-11-3.png]]与将一个帧存放在一块连续内存中不同，使用非连续（discontiguous）缓冲区时，一个帧可以由分散在内存各处的一系列帧段组成。<strong>因此，帧的起始位置仍然由一个缓冲区指针标识，但该指针只对应帧的第一个段。整个帧需要通过遍历一个缓冲区指针的链表来引用，如图 17-12 所示。</strong>
这些内存指针的链表<strong>可以存放在输出队列的数据结构中（如图 17-12 所示），也可以存放在帧数据缓冲段自身内部，即在每个数据缓冲段的末尾包含下一个内存指针或一个表示链表结束的标志</strong>。每个帧段可以具有可变长度。通常，硬件支持一个最小的段长度，并且每个段的总长度是该最小长度的整数倍。
与任何固定长度缓冲方案相比，非连续、可变长度缓冲区的方法能够更高效地利用内存。在最坏情况下，分配后未被使用的内存最多为 “一个最小长度缓冲区减去 1 字节”，而不是“一个最大帧的大小”。采用链表缓冲区方案，可以支持比固定长度缓冲方式更大的帧，同时不牺牲内存效率。
Token Ring 和 FDDI LAN 的帧长度比以太网更大；虽然在处理 1,522 字节以太网帧时，使用固定长度缓冲区带来的内存利用率下降通常可以接受，但对于一些 Token Ring 系统使用的 18 KB 帧而言，为了提高内存利用率，采用更复杂的内存接口可能是合理的。</p>
<h4 id="memory-bandwidth-limitations">Memory Bandwidth Limitations</h4>
<p>简单来说，如果一个系统能够使用共享内存交换结构（shared memory switch fabric），那么它大概率就应该使用共享内存结构。共享内存架构通常是交换机设计中最简单、成本最低的解决方案。既然如此，为什么会有交换机设计者不选择共享内存方式呢？
原因在于：<strong>所有帧都必须通过同一块共享内存</strong>，因此内存接口的速度最终会限制交换机的总容量。
举例来说，假设内存系统具有：
- <strong>32-bit 数据通路</strong>
- <strong>10 ns 同步静态 RAM (SSRAM)</strong>
- <strong>100 MHz 时钟</strong>
每个帧至少必须经过内存接口两次：
1. 一次由输入端口写入共享内存 
2. 一次由输出端口从共享内存读出
这实际上<strong>将可用的内存带宽减半</strong>。
在最佳情况（流式访问：即只有<strong>连续读写才能达到 10 ns 访问延迟，而随机访问无法达到</strong>），交换机的总容量受限为：
$$
32\ \text{bits} \times 100\ \text{MHz} \div 2 = 1.6\ \text{Gb/s}<br />
$$</p>
<blockquote>
<p>为什么随机访问无法达到连续读写的性能？
连续访问只进行一次地址译码，后续访问使用内部地址计数器；而随机访问每次都需要重新译码</p>
</blockquote>
<p>但在实际系统中，不可能完全享受同步 RAM 的流式访问带来的加速；其真实性能提升取决于读写帧数据的消息系统设计。通常，可用的内存带宽只有理论最大值的 <strong>50%–70%</strong>。
此外，为了避免无界的排队延迟，<strong>有效内存带宽至少需要超额预留（undersubscribe）30%</strong>。
这意味着，可用的无阻塞交换容量大约只有原始带宽的 <strong>35%–50%</strong>，在上述例子中约为：
<strong>550–800 Mb/s</strong>
假设所有端口都工作在全双工模式，这个容量可以支持：
- 一个 <strong>10 Mb/s、端口数量为 24–48</strong> 的交换机  <br />
- 或一个 <strong>48 口 10 Mb/s + 两个 100 Mb/s 上行链路</strong> 的交换机
但对于 <strong>多于 8 个 100 Mb/s 端口</strong> 的情况，该设计无法提供无阻塞性能。
因此，这个设计示例只适用于桌面型或小型工作组交换机。</p>
<h4 id="increasing-the-memory-bandwidth">Increasing the Memory Bandwidth</h4>
<p>为了使共享内存交换结构能够用于更高性能的交换机，可以采取多种方法来增加内存带宽：
1. <strong>使用最快的内存产品</strong><br />
    显然，更快的内存可以让系统设计者在更高的时钟频率下工作，而不会引入等待周期（wait states）。然而，由于当前半导体技术的物理限制，内存速度总是有上限。此外，最快的内存产品价格也最高，这会抵消共享内存架构的一些成本优势。
2. <strong>使用更宽的内存数据通路</strong><br />
    即使内存自身的时钟受限，也可以通过加宽数据通路来提高总内存带宽。单个时钟周期传输更多位数据，内存带宽就会与内存接口宽度成正比。例如，将数据通路从 32 位改为 64 位即可将内存带宽翻倍，从而支持一个 12–16 端口的非阻塞 100 Mb/s 工作组交换机。
标准内存产品通常设计用于 16、32 或 64 位宽的数据通路。此外，内存技术的发展通常偏向于实现更高的存储密度，即在单个芯片上集成更多内存。以目前的 SSRAM 芯片为例，每位宽度大约对应 1 Mbit 深度。因此，一个 64 位宽的内存阵列通常至少需要 8 Mbyte（64 Mbit）的总容量。如果需要更高的内存带宽，可以使用 128 或 256 位宽的数据通路，但这会导致总内存容量翻倍或四倍（16 或 32 Mbyte），因为必须使用标准内存芯片。
在很多情况下，这样做虽然提高了内存带宽，但总内存容量远超过交换机实际需求。由于传统内存产品并未针对“宽而浅”的内存阵列进行优化，你往往不得不为不需要的额外内存支付费用，仅仅为了获得更快的数据通路。
3. <strong>使用非传统内存</strong><br />
    除了通过加宽传统内存数据通路的“暴力”方法外，还有一些替代内存设计可提供更高接口带宽，包括：
    - <strong>同步图形内存（SGRAM）</strong>：类似于局域网交换机，图形显示子系统通常需要比传统计算机内存更宽、更浅的内存配置。一些半导体厂商提供了具有这种特性的特殊 SGRAM。它偶尔被用于局域网交换机，但由于销量低、市场有限，价格比传统 RAM 高。
    - <strong>Rambus 动态内存（RDRAM）</strong>：设计用于高性能 PC、工作站和服务器，RDRAM 支持 600 MHz 及更高的接口时钟频率。这类高性能内存价格也较高，但可以将共享内存交换结构应用到更高端的交换机产品中。
    - <strong>使用嵌入式内存</strong>：即使你愿意为实现 4–6 Gb/s 带宽的交换机购买 32 Mbyte、256 位宽的 SSRAM 阵列，连接这些外部内存所需的引脚数量也是一个问题。高性能交换机所用的定制 ASIC 芯片成本中，很大一部分与封装要求相关。如果仅连接内存就需要超过 256 个引脚（包括仲裁、控制、电源信号以及数据通路），将显著增加交换机成本。
越来越有吸引力的方案是将内存嵌入到交换机 ASIC 内部。如果内存是片内的，而非外部芯片，就无需引脚（或封装焊盘）。此外，片内逻辑时钟可以比外部内存更快，因为电感更低、电流驱动更小。嵌入式内存的数据通路宽度可达到 512 位或更高，而且几乎不增加成本。</p>
<h3 id="crosspoint-matrix">Crosspoint Matrix</h3>
<p>![[25-12-11-4.png]]
如图 17-14 所示，<strong>交叉点矩阵（crosspoint matrix）交换结构</strong>在一个帧（或帧的一部分）传输期间，为输入端口和输出端口之间创建一个临时连接。实际上，该结构包含一个电子开关矩阵，可以在任意输入与任意输出端口之间建立连接。
交换结构的控制逻辑会在<strong>每一帧</strong>的基础上，用<strong>纳秒级的时间将某个输入端口连接至相应的输出端口，然后在准备下一次帧传输前断开这些端口的连接</strong>。
交叉点矩阵交换结构通常也被称为 <strong>crossbar（交叉开关）</strong>；两个术语是同义的。
由于每个输入端口可以同时被连接到某个输出端口，因此交叉点矩阵能够提供的总数据传输能力远高于共享总线结构，且其带宽<strong>会随着端口数量的增加而增长</strong>。</p>
<h4 id="multicasting-in-a-crosspoint-matrix-fabric">Multicasting in a Crosspoint Matrix Fabric</h4>
<p>与共享内存或共享总线架构不同，<strong>交叉点矩阵（crosspoint matrix）本身不具备让一个输入端口同时向多个输出端口传输帧的天然机制</strong>。在 crosspoint 结构中，通常有两种方法处理多播（multicast）流量：
<strong>1. 使用多次单播传输（Multiple Unicast Transfers）</strong>
简单来说，当一个帧需要被发送到多个输出端口时，输入端口可以依次对每个目标输出端口执行一次独立的帧传输。
与共享内存架构类似，输入端口会维护一个 <strong>Transmit Port Map</strong>，表示该帧需要被传输到的所有目标输出端口集合。随着交换结构的仲裁和帧传输进行，每成功传输到一个输出端口，就在该列表中将该端口标记为已完成。当 Transmit Port Map 中所有位都变为 0 后，输入端口即可释放该帧缓冲。
<strong>优点：</strong>
- 简化 crosspoint 矩阵交换结构的设计。不需要为多播流量特别设计额外机制。
<strong>缺点：</strong>
- 输入端口的逻辑变得更复杂，需要跟踪多播帧的传输进度。
虽然多次传输同一帧看上去会浪费交换结构的容量，但实际上，一个多播帧最终仍然必须占用所有目标输出端口的带宽。<br />
如果交换结构被设计为可支持所有端口带宽总和，那么即便多播帧以多次单播方式发送，系统仍然是 <strong>non-blocking（无阻塞）</strong> 的。
不过，任何用于设计时的<strong>额外带宽余量（over provisioning）</strong>，都会因为多播复制而减少。系统依然能处理全部流量，但<strong>队列时延（交换延迟）会增加</strong>，尤其当多播流量占比显著时。
<strong>2. 提供专用的多播数据路径（Dedicated Multicast Data Path）</strong>
另一种方法是在交换机中提供一个或多个专用于多播流量的逻辑输出端口。
该<strong>多播端口本质上是一个共享总线（shared bus）</strong>，它被连接到所有输出端口，并与每个端口的单播专用线路并行，如图 17-15 所示。
![[25-12-11-5.png]]
当以下情况成立时，这种方法是合理的：
- 多播流量占总负载比例较小 
- 交换矩阵本身是阻塞式的或可用余量不大
通过将多播流量从交换矩阵的独立端口输出线路上分离出来，就避免了前面提到的帧复制问题，从而可以把大部分交换能力保留给单播流量（假设单播是主要流量）。
<strong>这种方法的缺点包括：</strong>
1. <strong>每个输出端口必须能够同时接收两路数据：</strong>
    - 来自交换矩阵的专用单播输出
    - 来自共享多播端口的多播输出
2. <strong>共享多播总线本身可能成为瓶颈</strong>
    如果多播流量占总负载比例较大，共享多播总线的容量可能无法满足需求。</p>
<blockquote>
<p>如果 crossbar 是 <strong>blocking</strong> 或 <strong>没有带宽余量</strong>，则每次连接可能都要等待仲裁，多播帧的复制会占掉大量 fabric 带宽，尤其是多播流量一多，会让 <strong>整个交换机的单播流量受到影响</strong></p>
</blockquote>
<h4 id="crosspoint-matrix-implementation">Crosspoint Matrix Implementation</h4>
<p>实现交叉点矩阵（crosspoint matrix）的两种常见方法如下：
<strong>1. 物理矩阵（physical matrix）</strong>
这种矩阵可以通过以下方式构建：<br />
在一个平面上平行铺设导电材料条带（对应输入端口），在另一个平面上以直角方向铺设导电条带（对应输出端口）。<br />
每一条输入端口的导线都通过一个晶体管开关电路连接到每一个输出端口的导线；<br />
交换控制逻辑根据输入端口控制器的请求以及仲裁器的仲裁结果（参考 17.3.3.5 节），决定哪些晶体管应该闭合或断开。<br />
也就是说，图 17-14 所示的就是这种物理交叉点矩阵的结构。
根据交换矩阵的数据速率，往往需要为每个端口使用多条导线轨迹（输入端口和输出端口都是如此）。<br />
这样，每个时钟周期可以传输多个比特数据，从而降低时钟频率。但其代价是交换芯片的端口引脚数量会增加。
<strong>2. 逻辑矩阵（logical matrix）</strong>
这种矩阵通过逻辑组合实现：<br />
每个输出端口的信号由输入端口信号经过某种逻辑函数生成，而这个逻辑关系由<strong>交换矩阵仲裁器</strong>控制。<br />
换言之，交叉点矩阵可以完全用标准数字逻辑模块实现。
与物理矩阵类似，也可以通过为每个输入和输出定义多条并行信号来降低时钟速度，但这同样会增加接口的引脚数量。
<strong>两种实现方式的比较</strong>
- <strong>物理矩阵</strong>
    - 优点：规模更小、复杂度更低，能实现更低成本的交换矩阵。 <br />
    - 缺点：电路往往必须定制布局，不适合使用常规的 IC 综合设计工具在硅片上生成。<br />
- <strong>逻辑矩阵</strong>
    - 优点：使用可综合逻辑，因此更容易在不同的半导体工艺之间迁移，也不需要非常专门的芯片布局设计技能。
    - 缺点：可能更大、更复杂。
根据时钟频率和端口宽度，逻辑矩阵可以实现非常大的交换能力。例如，一个 <strong>16 端口、每端口 16bit 宽、100MHz 时钟</strong> 的矩阵，其有效数据交换能力可达：
<strong>16 ports × 16 bits × 100 MHz = 25.6 Gb/s</strong>
这样的交换矩阵可以支持大量的 <strong>100Mb/s 端口</strong> 或相当数量的 <strong>1GbE 端口</strong>。</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["search.suggest", "search.highlight", "search.share", "navigation.tabs", "navigation.path", "navigation.top", "navigation.footer", "navigation.indexes", "content.code.copy", "content.code.select"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>